**功能上** 

sbus遥控接收功能

- 通道3作为车的油门控制2006电机转速

- 通道4作为车的方向,两个2006差速转向
- 通道2作为吸附腔的大小,pwm风机
- 通道5作为变形通道,上为飞行模式,下为车载模式
- 通道6作为控制模式通道, 上为上位机控制模式, 中为遥控控制模式, 下为急停

两栖功能

- 车模式: 两个2006电机, 控制速度环, 差速转向

- 飞行模式: 全部交给飞控, 飞控检测通道五

变形功能

- 从车载模式到飞行模式, 先正转3508电机, 当3508电机发生堵转时停止转动, 然后推出电推杆直到完全推出
- 从飞行模式到车载模式, 先收缩电推杆, 电推杆收缩完成之后, 3508反转知道堵转
- 3508堵转的判定有现成接口可以使用, 电推杆推出和收缩只能通过较长延时的方法实现

与上位机通信功能

- 上行: 陀螺仪数据, 轮子里程, 系统状态 
- 下行: 控制命令

自检功能

- OLED显示设备在线情况

  - CAN设备(2006 3508)是否在线

  - 上位机是否在线

- 上电开启LED流动, 蜂鸣器播放音乐



**根据功能的线程分配**

车辆控制线程 (Vehicle Task)

- 优先级: `osPriorityNormal`
- 功能:
  - 读取SBUS的ch[2]（通道3）作为油门→控制两个2006电机转速
  - 读取SBUS的ch[3]（通道4）作为方向→控制2006差速转向
- 延迟: 2ms

变形控制线程 (Transform Task)

- 优先级: `osPriorityNormal`
- 功能:
  - 监听SBUS的ch[4]（通道5）变形指令
  - 3508变形电机控制
  - 四个电推杆GPIO脉冲控制(一个GPIO控制四个电推杆)
- 延迟: 10ms

吸附系统线程 (Suction Task)

- 优先级: `osPriorityNormal`
- 功能: 根据SBUS的ch[1]（通道2）控制PWM风机
- 延迟: 20ms

上位机通信线程 (Communication Task)

- 优先级: `osPriorityNormal`
- 功能: 串口通信（上行发送数据，下行接收指令）
- 延迟: 50ms

陀螺仪数据处理线程

- 优先级: `osPriorityNormal`
- 功能: 处理六轴数据解算欧拉角

- 延迟: 1ms

自检线程

- 优先级: `osPriorityNormal`
- 功能: OLED显示设备在线情况, 上电开启LED流动, 蜂鸣器播放音乐

- 延迟: 100ms


默认线程

- 功能: 管理控制模式, 通道6作为控制模式通道, 上为上位机控制模式, 中为遥控控制模式, 下为急停

**有关硬件配置**

CAN设备

- M2006(左轮)  → CAN ID: 1  (0x200标识符控制)
- M2006(右轮)  → CAN ID: 2  (0x200标识符控制)  
- 3508(变形)   → CAN ID: 3  (0x200标识符控制)

GPIO设备

- 风机PWM TIM1_CH1
- 电推杆脉冲信号 PI7

UART设备

- 调试信息串口 UART1
- 上位机通信串口 UART6

**控制逻辑**

- 命令: 遥控器命令 > 上位机命令 (只有遥控器设置为上位机控制模式时, 上位机命令才起作用)
  - 遥控器通道5作为变形通道,上为飞行模式,下为车载模式
  - 遥控器通道6作为控制模式通道, 上为上位机控制模式, 中为遥控控制模式, 下为急停
  - 上位机通过通信线程控制车载模式的机器人速度和角速度
- 执行: 
  - 默认线程负责总管系统所有的状态信息, 并且负责执行遥控急停(最高优先级)
  - 处理遥控器通道5和6, 设置机器人的状态
  - 各具体执行线程根据状态执行相应控制

**其它**

电推杆的GPIO脉冲控制逻辑是: 

- 低有效脉冲, 低电平的持续时间至少需要100ms.
- 每给一次信号, 电推杆的状态就改变一次, 改变顺序为: 正推-停止-反拉-停止-正推 如此循环.



tag

帮我根据README中变形功能的描述完成main.cc中的变形线程, m3508_antijam.cc是使用电机控制接口的一个例子.
